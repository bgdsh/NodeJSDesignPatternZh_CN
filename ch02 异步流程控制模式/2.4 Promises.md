# Promises
在本章之初就已经提过，CPS不是写异步代码的唯一方式。事实上，JavaScript系统为传统的回调模式提供了备选方案。一个势头正劲的备选方案，将会成为ECMAScript6说明的一部分（被称为ES6 或 Harmony），ES6是JavaScript语言的未来版本。这里说的是**promise**，尤其是遵循*Promises/A+*说明来实现的特定版本（https://promisesaplus.com ）。
>注：有其它promises实现，它们和*Promises/A+*不一样，在这些说明中，最流行的是JQuery提供的模式。在本节讨论的大部分话题不适用于这些不兼容的实现。 

## 什么是Promise
简单地说，promises是一种抽象，允许异步函数返回一个叫做**promise**的对象，代表操作的最终结果。在promises术语中，当异步操作没有完成时，叫做**pending**，当操作成功完成后，是**fullfilled**状态，当操作因为错误终止时，叫做**rejected**状态。当一个promise要么fullfilled，要么rejected，都被认为是**settled**。
可以使用promise的`then()`方法来接收执行成功的结果或者是执行失败的错误原因。以下是它的签名：

```
promise.then([onFulfilled], [onRejected])
```
这里`onFullfilled()`是一个函数，会接收promise执行成功时的结果，`onRejected()`是另一个函数，会接收终止的原因（如果有的话）。两个函数都是可选的。
看下面的代码来了解Promise是怎样改变我们的代码的：

```
asyncOperation(arg, function(err, result) {
    if(err) {
        //handle error
    }
    //do stuff with result
});
```
`then()`方法的一个关键特性是它可以同步地返回另一个Promise。如果`onFulfilled()`或`onRejected()`返回一个值x，由`then()`返回的promise 可以是：

* 如果x是值类型，则执行顺利完成，结果为x
* 如果x是一个promise或者是一个*thenable*的对象，则顺利完成时的结果是x顺利完成时返回的值。
* 如果x是一个promise或者是一个*thenable*的对象，则失败时的结果是x失败时返回的值。

> thenable 是指一个类似于promise的对象，包含一个`then()`方法。这个术语用于表示使用不同的手段实现的某种promise。

这个特性使我们可以构建promise链，使我们可以方便地聚合、编排多种不同的异步操作。此外，如果不想制定`onFulfilled()`、`onRejected()`处理函数，成功时的返回值或者失败时的错误原因都会自动地传递到链中的下一个promise。这使我们可以自动地在整个链上自动地传递错误，直到它被`onRejected()`函数处理。使用promise链，顺序执行的任务突然变成了简单的操作：

```
asyncOperation(arg)
    .then(function(result1) {
        //returns another promise
        return asyncOperation(arg2);
    })
    .then(function(result2) {
        //returns a value
        return 'done';
    })
    .then(undefined, function(err) {
        //any error in the chain is caught here
    });
```
下图从另外一个角度展示了promise链的工作模式：

![](../images/promise_chain.png)
promise的另外一个重要特性是`onFulfilled()`和`onRejected`函数一定会被异步地触发，即使同步地用一个值来返回结果，和前面的结果一样，在链的前一个`then()`中返回了字符串`done`。这个设定使我们避免发生放出恶魔的情况，使代码的一致性和健壮性不会受到影响。
接下来是最好的部分。如果在`onFulfilled`或`onRejected`处理函数中抛出一个异常（使用`throw`命令），被`then()`返回的promise会自动地使用异常作为原因来使promise进入被拒绝状态。相对于`CPS`来说，这有着极大的优势，这意味着使用promise，异常会自动地在链上传递，这样一来，`throw`命令便不再是敌人了。

> 了解更多关于Promise/A+规范的描述，可以参照官方网站：[https://promisesaplus.com/](https://promisesaplus.com/)。

## Promises/A+ 的实现

## 把一个Node.js风格的函数Promise化

## 顺序执行

### 顺序遍历

### 顺序遍历的模式

## 并行执行

## 有限的平行执行



